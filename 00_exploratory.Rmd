---
title: "Exploratory Analysis"
output:
  html_document:
    keep_md: yes
---

```{r setup, include=FALSE}
library(ProjectTemplate)
load.project()
```

# Independent Variable Characterization

```{r rev_hist}
DATA %>%
  filter(dataset=="TRAIN") %>%
  ggplot(aes(revenue)) +
  geom_density() +
  geom_vline( aes(xintercept=mean(revenue) ), color="blue") +
  geom_vline( aes(xintercept=mean(revenue)+3*sd(revenue) )) +
  geom_vline( aes(xintercept=mean(revenue)+2*sd(revenue) )) +
  geom_vline( aes(xintercept=mean(revenue)+sd(revenue) )) +
  geom_vline( aes(xintercept=mean(revenue)-sd(revenue) )) +
  theme_bw()
```

Blue line is mean. Black lines are 1, 2, 3 SD's from the mean.

# Dependent Variable Characterization

## Open Date

`date` is a parsed version of Open.Date.

```{r hist_date}
DATA %>%
  ggplot(aes(x=date, y=..density..)) +
    geom_histogram() +
    facet_wrap(~dataset) +
    xlab("Date of Store Opening") +
    ylab("Stores Opened (Density)") +
    theme_bw()
```

```{r revenue_date}
DATA %>%
  filter(dataset=="TRAIN") %>%
  ggplot(aes(x=date, y=revenue)) +
    geom_point() +
    geom_smooth() +
    xlab("Date of Store Opening") +
    ylab("Revenue") +
    theme_bw()
```

## City and City.Group

```{r map}
# get_map(location="Turkey", zoom=5) %>%
#   ggmap +
#   geom_point(data = DATA, aes(lon, lat, color=City.Group, shape=dataset), position = "jitter", size=2) +
#   scale_shape_manual(values=c(0, 15))
```

Yep, its Turkey!

```{r city}
setdiff(TEST$City, TRAIN$City)
setdiff(TRAIN$City, TEST$City)
table(DATA$dataset, DATA$City)
table(DATA$dataset, DATA$City.Group)
```

**Issue**: Some cities found in TEST are not present in TRAIN.

```{r date_revenue_citygroup}
DATA %>%
  filter(dataset=="TRAIN") %>%
  ggplot(aes(x=date, y=revenue, color=City.Group)) +
    geom_point() +
    geom_smooth() +
    xlab("Date of Store Opening") +
    ylab("Revenue") +
    theme_bw()
```

```{r month_revenue_citygroup}
DATA %>%
  filter(dataset=="TRAIN") %>%
  ggplot(aes( month(date), revenue, color=City.Group)) +
    geom_point() +
    geom_smooth() +
    theme_bw()
```

## Type

```{r Type}
table(DATA$dataset, DATA$Type)
```

```{r date_revenue_type}
DATA %>%
  filter(dataset=="TRAIN") %>%
  ggplot(aes(x=date, y=revenue, color=Type)) +
    geom_point() +
    geom_smooth() +
    xlab("Date of Store Opening") +
    ylab("Revenue") +
    theme_bw()

```

**Issue**: Missing an `MB` level in TRAIN.

## Lat/Lon

```{r latlon}
DATA %>%
  filter(dataset=="TRAIN") %>%
  ggplot(aes(lat, revenue)) +
  geom_line() +
  geom_smooth()

DATA %>%
  filter(dataset=="TRAIN") %>%
  ggplot(aes(lon, revenue)) +
  geom_line() +
  geom_smooth()

DATA %>%
  filter(dataset=="TRAIN") %>%
  ggplot( ) +
  geom_point( aes( cut(lon,4), cut(lat,4), size=cut(revenue,4)), position="jitter" ) +
  theme_bw() +
  xlab("Longitude Range") +
  ylab("Latitude Range") +
  ggtitle("Revenue vs. Lat/Lon")
```

# Mystery Variable Characterization

## Levels and Range Comparison

```{r mystery_variable_ranges}
MV_RANGES = DATA %>%
  group_by(dataset) %>%
  select(P1:P37) %>%
  summarise_each(funs(
    min = min(.),
    max = max(.),
    lev = length(unique(.))
    ), P1:P37) %>%
  gather(varname, value, P1_min:P37_lev) %>%
  group_by(varname) %>%
  summarize(
    min=min(value),
    max=max(value)
  ) %>%
  separate(varname, c("var", "metric")) %>%
  arrange(var, metric) %>%
  mutate(
    odd = ifelse(
      min != max,
      TRUE, FALSE)
  )

# How many discrepancies of each type
table(MV_RANGES$odd, MV_RANGES$metric)

# Print discrepancies
MV_RANGES %>%
  filter(odd) %>%
  print.data.frame
```

**Issue**: Range discrepancies between TEST and TRAIN.

**Issue**: Some of the mystery variables have differing numbers of distinct values.

Clint has a theory that the mystery vars with small numbers of levels
are candidates for categorical treatment. Lets see.

```{r test}
MV_ODD = MV_RANGES %>%
  group_by(var) %>%
  mutate(
    odd = any(odd)
  ) %>%
  filter(metric=="lev") %>%
  select(
    lev = min,
    odd
  )
table(MV_ODD$odd, MV_ODD$lev)
```

Inconclusive.

## Histograms

```{r mystery_variable_histograms}
P_mv_histogram = DATA %>%
  select(dataset, P1:P37) %>%
  gather(varname, value, P1:P37) %>%
  select(varname, dataset, value) %>%
  group_by(varname) %>%
  do(
    plot = ggplot(., aes(x=value, y=..density..)) +
      geom_histogram(binwidth=1) +
      ggtitle(.$varname) +
      facet_wrap( ~ dataset) +
      ylab("Density") +
      theme_bw()
  )

P_mv_histogram %>%
  rowwise %>%
  do({
    print(.$plot)
    data.frame()
  })
```

# Correlated Predictors

```{r cor_pred}
TRAIN.P.cor = cor(select(TRAIN, P1:P37))
colnames(
  TRAIN[,findCorrelation(TRAIN.P.cor, cutoff = .95)]
  )
```

# Linear Combinations
```{r linear_combos}
TRAIN.P.lc = findLinearCombos(select(TRAIN, P1:P37))
```

# Zero in Data
```{r zero}
X = apply(DATA, 1, function(r) {
  length(which(r[6:43]==0))
})
```